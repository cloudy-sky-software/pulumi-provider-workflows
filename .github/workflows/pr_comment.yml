# This workflow is meant to be called by workflows in other repositories.
# That's why the event is `workflow_call` instead of `issue_comment` here.
on:
  workflow_call:
    inputs:
      comment-action:
        required: true
        type: string
      comment-body:
        required: true
        type: string
      state:
        required: true
        type: string
      pull-request-json:
        required: true
        type: string

jobs:
  pr_commented:
    # This job only runs for pull request comments.
    name: PR comment
    if: ${{ inputs.comment-action == 'created' && inputs.comment-body == '/regen all' && fromJson(inputs.pull-request-json) && inputs.state == 'open' && !fromJson(inputs.pull-request-json).merged_at }}
    runs-on: ubuntu-latest
    steps:
      - name: Regen schema and SDKs
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

          make gen generate_schema build

          git add provider/cmd/pulumi-resource-*
          git add sdk/*

          git commit -am "Regen schema and SDKs"

          git push origin ${GITHUB_REF_NAME}
